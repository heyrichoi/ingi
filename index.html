<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ïù∏Í∏∞ ÎèÑÎÑ§ Î£∞Î†õ</title>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    background: #1e1e24; /* Darker background */
    color: #e0e0e0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden; /* Prevent body scroll */
  }

  .app-container {
    width: 100%;
    max-width: 1400px;
    height: 100vh;
    display: grid;
    grid-template-columns: 450px 1fr; /* Fixed Roulette width, flexible Table width */
    gap: 0;
    background: #2b2b36;
  }

  /* --- LEFT COLUMN: ROULETTE --- */
  .roulette-section {
    background: #25252e;
    display: flex;
    flex-direction: column;
    align-items: center;
    /* Space evenly to fit everything without scrolling */
    justify-content: space-evenly; 
    padding: 20px;
    border-right: 1px solid #3a3a45;
    position: relative;
    height: 100vh;
    overflow: hidden; /* Hide scrollbar */
    z-index: 10;
  }

  .wheel-container {
    position: relative;
    /* Responsive size: fit within available space but max 380px */
    width: 380px;
    height: 380px;
    max-width: 40vh;
    max-height: 40vh;
    flex-shrink: 0;
  }
  
  .wheel-ring {
    position: absolute;
    inset: -10px;
    border-radius: 50%;
    background: linear-gradient(135deg, #444, #111);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    z-index: 1;
  }

  /* Wrapper for rotating content (Canvas + Labels) */
  .wheel-rotator {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    position: relative;
    z-index: 2;
    /* Transformation handled by JS */
  }

  .wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    position: absolute;
    top: 0;
    left: 0;
    overflow: hidden;
    border: 8px solid #333;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
  }
  
  .wheel-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    background: #fff;
    border-radius: 50%;
    z-index: 10;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
  }

  .pointer {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 50px;
    z-index: 20;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.4));
  }

  /* Labels inside wheel - NEW LOGIC */
  .wheel-labels {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 5;
    border-radius: 50%;
    overflow: hidden;
  }
  .slice-label {
    position: absolute;
    top: 50%;
    left: 50%;
    /* Start from center, go to edge */
    width: 50%; 
    height: 0px; /* Zero height wrapper */
    transform-origin: 0% 50%; /* Pivot at center of wheel */
    display: flex;
    align-items: center;
    justify-content: center; /* Center text within the radius line */
    padding-left: 40px; /* Push text away from center hub */
    padding-right: 10px;
  }
  .slice-label span {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #fff;
    font-weight: bold;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    font-size: 14px;
    max-width: 100%;
  }

  /* Result Display */
  .result-display {
    text-align: center;
    margin: 10px 0;
    height: 60px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .result-label {
    font-size: 14px;
    color: #888;
    margin-bottom: 5px;
  }
  .result-value {
    font-size: 24px;
    font-weight: 800;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
  }

  /* --- Calculator Section --- */
  .calc-container {
    width: 100%;
    max-width: 380px;
    background: #1a1a20;
    border: 1px solid #3a3a45;
    border-radius: 12px;
    padding: 15px;
    flex-shrink: 0;
  }
  .calc-header {
    color: #5c6bc0;
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .calc-header svg {
    width: 18px;
    height: 18px;
  }
  .calc-input-group {
    display: flex;
    align-items: center;
    background: #111;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 0 10px;
    margin-bottom: 5px;
  }
  .calc-input-group input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    padding: 10px 5px;
    font-size: 14px;
    text-align: right;
    outline: none;
  }
  .calc-input-group span {
    color: #888;
    font-size: 12px;
    margin-left: 5px;
  }
  .calc-arrow {
    text-align: center;
    color: #555;
    font-size: 11px;
    margin: 3px 0;
  }
  .calc-result-box {
    background: #25252e;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    border: 1px solid #333;
  }
  .calc-stack {
    font-size: 24px;
    font-weight: 900;
    color: #4caf50;
    text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
  }
  .calc-stack-label {
    font-size: 12px;
    color: #aaa;
    margin-left: 2px;
  }
  .calc-sub-text {
    display: block;
    margin-top: 2px;
    font-size: 11px;
    color: #777;
  }
  .calc-highlight {
    color: #ddd;
    font-weight: bold;
  }


  /* --- RIGHT COLUMN: CONTROLS & TABLE --- */
  .controls-section {
    display: flex;
    flex-direction: column;
    padding: 30px 40px;
    background: #2b2b36;
    height: 100vh;
    overflow: hidden;
    position: relative; /* For mascot positioning */
  }

  /* Mascot Image */
  .mascot-img {
    position: absolute;
    bottom: 0;
    right: 0;
    height: 70vh; /* Takes up substantial height */
    width: auto;
    object-fit: contain;
    z-index: 0; /* Behind everything */
    pointer-events: none; /* Let clicks pass through */
    opacity: 0.9; /* Slight transparency if needed */
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  /* Header Area: Timer & Spin Button */
  .controls-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    position: relative;
    z-index: 2; /* Above mascot */
  }

  /* Spin Button */
  .spin-btn {
    background: #5c6bc0;
    color: white;
    border: none;
    padding: 12px 40px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 0 #3949ab;
    transition: all 0.1s;
    width: 200px;
  }
  .spin-btn.stop-mode {
    background: #ef5350;
    box-shadow: 0 4px 0 #c62828;
  }
  .spin-btn:hover { filter: brightness(1.1); }
  .spin-btn:active { transform: translateY(4px); box-shadow: none; }
  .spin-btn:disabled { background: #444; color: #888; box-shadow: none; cursor: not-allowed; }

  /* Timer */
  .timer-box {
    text-align: right;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }
  .timer-label {
    font-size: 12px;
    color: #aaa;
    margin-bottom: 2px;
  }
  .timer-display {
    font-family: 'Courier New', monospace;
    font-size: 32px;
    font-weight: bold;
    color: #ff6b6b;
    background: #1a1a20;
    padding: 4px 12px;
    border-radius: 6px;
    border: 1px solid #444;
    cursor: pointer; /* Click to edit */
  }
  .timer-edit-input {
    font-family: 'Courier New', monospace;
    font-size: 32px;
    font-weight: bold;
    color: #ff6b6b;
    background: #1a1a20;
    border: 1px solid #5c6bc0;
    width: 140px;
    padding: 4px;
    border-radius: 6px;
    text-align: right;
    display: none;
  }

  /* Data Table */
  .data-table-container {
    flex: 1;
    /* Semi-transparent background to show mascot */
    background: rgba(30, 30, 36, 0.85); 
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border: 1px solid #3a3a45;
    position: relative;
    z-index: 1; /* Above mascot */
    backdrop-filter: blur(2px); /* Helps readability */
  }

  .table-header {
    display: grid;
    grid-template-columns: 60px 2fr 1fr 1fr; /* Del/Lock, Name, Size, Prob */
    background: #3f51b5;
    color: white;
    font-weight: bold;
    padding: 12px 16px;
    font-size: 14px;
    align-items: center;
    text-align: center; /* Center header text */
  }
  
  .table-body {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 60px; /* Space for add button */
  }

  .table-row {
    display: grid;
    grid-template-columns: 60px 2fr 1fr 1fr;
    padding: 10px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.05); /* Lighter border */
    align-items: center;
    transition: background 0.2s;
  }
  .table-row:hover { background: rgba(37, 37, 46, 0.9); }

  .cell-action { 
    display: flex; 
    justify-content: center; 
    align-items: center; 
  }
  .btn-delete {
    background: #ff5252;
    border: none;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
  }
  .btn-delete:hover { background: #ff1744; }

  /* Input centering */
  .cell-name {
    display: flex;
    justify-content: center;
  }
  .input-ghost {
    background: transparent;
    border: 1px solid transparent;
    color: #fff;
    font-size: 14px;
    padding: 6px;
    width: 90%;
    border-radius: 4px;
    text-align: center; /* Center text in inputs */
  }
  .input-ghost:focus {
    border-color: #5c6bc0;
    background: #121216;
    outline: none;
  }

  /* Weight Control Cell */
  .cell-weight {
    display: flex;
    align-items: center;
    justify-content: center; /* Center the whole group */
    gap: 4px;
  }
  .weight-btn {
    background: #333;
    color: #aaa;
    border: 1px solid #444;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    padding: 0;
  }
  .weight-btn:hover {
    background: #444;
    color: #fff;
  }
  .input-number {
    text-align: center; /* Center number */
    font-family: monospace;
    opacity: 1; 
    width: 40px;
    padding: 4px;
    background: #1a1a20; /* Slight bg to make it distinct */
    border: 1px solid #333;
  }
  /* Remove spinner from number input */
  .input-number::-webkit-outer-spin-button,
  .input-number::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .prob-text {
    text-align: center; /* Center prob text */
    color: #bbb;
    font-size: 14px;
  }

  /* Add Button Row */
  .add-row {
    padding: 10px 16px;
    border-top: 1px solid #3a3a45;
    background: #25252e;
  }
  .btn-add {
    width: 100%;
    background: #4caf50;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background 0.2s;
  }
  .btn-add:hover { background: #43a047; }

  /* Export Area */
  .export-area {
    margin-top: 20px;
    padding: 15px;
    background: #1a1a20;
    border-radius: 8px;
    border: 1px solid #333;
    display: flex;
    gap: 10px;
    align-items: center;
    position: relative;
    z-index: 2; /* Above mascot */
  }
  .export-input {
    flex: 1;
    background: #111;
    border: 1px solid #444;
    color: #888;
    padding: 8px;
    border-radius: 4px;
    font-size: 12px;
  }
  .btn-copy {
    background: #444;
    color: #ddd;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  .btn-copy:hover { background: #555; }

  /* Modal & Overlays */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
  }
  .modal {
    background: linear-gradient(135deg, #f97316, #ea580c);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    border: 4px solid #fcd34d;
    min-width: 400px;
    transform: scale(0.8);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .modal.show {
    transform: scale(1);
    opacity: 1;
  }
  .modal h2 {
    color: #fff7ed;
    font-size: 1.5rem;
    margin: 0 0 20px 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .winner-text {
    font-size: 3.5rem;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
    margin-bottom: 10px;
  }
  .modal-hint {
    color: rgba(255,255,255,0.8);
    margin-top: 20px;
    font-size: 0.9rem;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #333;
    color: #fff;
    padding: 10px 20px;
    border-radius: 20px;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    z-index: 2000;
  }
  .toast.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  @media (max-width: 900px) {
    .app-container { grid-template-columns: 1fr; height: auto; min-height: 100vh; overflow-y: auto; }
    .roulette-section { border-right: none; border-bottom: 1px solid #3a3a45; height: auto; padding-bottom: 40px; overflow: visible; }
    .controls-section { height: auto; overflow: visible; }
    .wheel-container { width: 300px; height: 300px; max-width: none; max-height: none; }
    .calc-container { margin-top: 20px; }
    .mascot-img { height: 40vh; } /* Smaller mascot on mobile */
  }
</style>
</head>
<body>

<div class="app-container">
  <!-- Left Side: Roulette & Calculator -->
  <section class="roulette-section">
    <div class="wheel-container">
      <div class="wheel-ring"></div>
      
      <!-- New Wrapper for Rotation -->
      <div class="wheel-rotator" id="wheelRotator">
        <div class="wheel" id="wheelCanvas"></div>
        <div class="wheel-labels" id="wheelLabels"></div>
      </div>

      <div class="wheel-center"></div>
      <!-- SVG Pointer -->
      <svg class="pointer" viewBox="0 0 40 50">
        <path d="M20 50 L0 0 L40 0 Z" fill="#ffeb3b" stroke="#f57f17" stroke-width="2"/>
      </svg>
    </div>

    <div class="result-display">
      <div class="result-label">ÎãπÏ≤® Í≤∞Í≥º</div>
      <div class="result-value" id="currentResult">-</div>
    </div>

    <!-- Toonation Stack Calculator -->
    <div class="calc-container">
      <div class="calc-header">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
        </svg>
        Ìà¨ÎÑ§Ïù¥ÏÖò Ïä§ÌÉù Í≥ÑÏÇ∞Í∏∞
      </div>
      <div class="calc-input-group">
        <input type="number" id="calcInput" placeholder="Í∏àÏï° ÏûÖÎ†•" inputmode="numeric" />
        <span>Ïõê</span>
      </div>
      <div class="calc-arrow">
        +20% (ÏàòÏàòÎ£å Ìè¨Ìï® Í≥ÑÏÇ∞)
      </div>
      <div class="calc-result-box">
        <div>
          <span class="calc-stack" id="calcStackResult">0</span>
          <span class="calc-stack-label">Ïä§ÌÉù</span>
        </div>
        <span class="calc-sub-text">
          Ï∂©Ï†Ñ Í∏àÏï°: <span id="calcTotalMoney" class="calc-highlight">0</span>Ïõê
        </span>
      </div>
    </div>
  </section>

  <!-- Right Side: Controls -->
  <section class="controls-section">
    <!-- Mascot Image (Background Layer) -->
    <img id="mascot" class="mascot-img" src="https://github.com/heyrichoi/ingi/blob/main/2-removebg-preview.png?raw=true" alt="Mascot">

    <!-- Header: Spin Button & Timer -->
    <div class="controls-header">
      <button class="spin-btn" id="spinBtn">ÎèåÎ¶¨Í∏∞!</button>

      <div class="timer-box">
        <div class="timer-label">ÏûêÎèô ÌÉÄÏù¥Î®∏ (ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ§Ï†ï)</div>
        <div class="timer-display" id="timerDisplay">02:00</div>
        <input type="number" class="timer-edit-input" id="timerInput" value="120" />
      </div>
    </div>

    <!-- Data Table -->
    <div class="data-table-container">
      <div class="table-header">
        <div>ÏÇ≠Ï†ú</div>
        <div>Ïù¥Î¶Ñ</div>
        <div>ÌÅ¨Í∏∞</div>
        <div>ÌôïÎ•†</div>
      </div>
      <div class="table-body" id="tableBody">
        <!-- Rows generated by JS -->
      </div>
      
      <!-- Fixed Add Button at bottom of list area -->
      <div class="add-row">
        <button class="btn-add" id="btnAddItem">
          <span>+</span> Ìï≠Î™© Ï∂îÍ∞Ä
        </button>
      </div>
    </div>

    <!-- Export Section (Hidden functionality for Donation Roulette) -->
    <div class="export-area">
      <div style="font-size:12px; color:#888; white-space:nowrap;">ÎÇ¥Î≥¥ÎÇ¥Í∏∞:</div>
      <input type="text" class="export-input" id="exportStr" readonly placeholder="Ïù¥Î¶Ñ*ÌÅ¨Í∏∞, Ïù¥Î¶Ñ*ÌÅ¨Í∏∞..." />
      <button class="btn-copy" id="btnCopy">Î≥µÏÇ¨</button>
    </div>
  </section>
</div>

<!-- Winner Modal -->
<div class="overlay" id="modalOverlay">
  <div class="modal" id="winnerModal">
    <h2>üéâ ÎãπÏ≤®! üéâ</h2>
    <div class="winner-text" id="winnerText">NAME</div>
    <div class="modal-hint">ÌôîÎ©¥ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞</div>
  </div>
</div>

<div class="toast" id="toast">Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§</div>

<script>
/**
 * Application State
 */
const state = {
  items: [
    { id: 1, name: 'Ïª§Ïä§ÌÖÄ 1', weight: 1 },
    { id: 2, name: 'Ïª§Ïä§ÌÖÄ 2', weight: 1 },
    { id: 3, name: 'Ïª§Ïä§ÌÖÄ 3', weight: 1 },
  ],
  isSpinning: false, // used to block interaction
  spinPhase: 'idle', // 'idle', 'spinning', 'stopping'
  rotation: 0,
  spinSpeed: 0,
  animationId: null,
  
  timerSeconds: 120, // Default 2 minutes
  defaultTimer: 120,
  timerInterval: null
};

const colors = [
  '#ef5350', '#ec407a', '#ab47bc', '#7e57c2', '#5c6bc0',
  '#42a5f5', '#29b6f6', '#26c6da', '#26a69a', '#66bb6a',
  '#9ccc65', '#d4e157', '#ffee58', '#ffca28', '#ffa726',
  '#ff7043', '#8d6e63', '#bdbdbd', '#78909c'
];

// URLs
const MASCOT_IDLE = 'https://github.com/heyrichoi/ingi/blob/main/2-removebg-preview.png?raw=true';
const MASCOT_ACTIVE = 'https://github.com/heyrichoi/ingi/blob/main/1-removebg-preview.png?raw=true';

// DOM Elements
const wheelCanvas = document.getElementById('wheelCanvas');
const wheelLabels = document.getElementById('wheelLabels');
const wheelRotator = document.getElementById('wheelRotator');
const tableBody = document.getElementById('tableBody');
const btnAddItem = document.getElementById('btnAddItem');
const spinBtn = document.getElementById('spinBtn');
const currentResult = document.getElementById('currentResult');
const exportStr = document.getElementById('exportStr');
const btnCopy = document.getElementById('btnCopy');
const timerDisplay = document.getElementById('timerDisplay');
const timerInput = document.getElementById('timerInput');
const modalOverlay = document.getElementById('modalOverlay');
const winnerModal = document.getElementById('winnerModal');
const winnerText = document.getElementById('winnerText');
const toast = document.getElementById('toast');
const calcInput = document.getElementById('calcInput');
const calcStackResult = document.getElementById('calcStackResult');
const calcTotalMoney = document.getElementById('calcTotalMoney');
const mascotImg = document.getElementById('mascot');

/**
 * Calculator Logic
 */
calcInput.addEventListener('input', (e) => {
  const val = parseInt(e.target.value, 10);
  if (isNaN(val) || val < 0) {
    calcStackResult.textContent = '0';
    calcTotalMoney.textContent = '0';
    return;
  }
  const totalMoney = val * 1.2;
  let stacks = totalMoney / 1000;
  const formattedStacks = Number.isInteger(stacks) ? stacks : stacks.toFixed(1);

  calcStackResult.textContent = formattedStacks;
  calcTotalMoney.textContent = Math.floor(totalMoney).toLocaleString();
});

/**
 * Timer Logic
 */
function startTimer() {
  clearInterval(state.timerInterval);
  state.timerSeconds = state.defaultTimer;
  updateTimerDisplay();
  
  state.timerInterval = setInterval(() => {
    if (state.timerSeconds > 0) {
      state.timerSeconds--;
      updateTimerDisplay();
    } else {
      clearInterval(state.timerInterval);
    }
  }, 1000);
}

function updateTimerDisplay() {
  const m = Math.floor(state.timerSeconds / 60).toString().padStart(2, '0');
  const s = (state.timerSeconds % 60).toString().padStart(2, '0');
  timerDisplay.textContent = `${m}:${s}`;
}

timerDisplay.addEventListener('click', () => {
  timerInput.style.display = 'block';
  timerDisplay.style.display = 'none';
  timerInput.value = state.defaultTimer;
  timerInput.focus();
});

timerInput.addEventListener('blur', finishTimerEdit);
timerInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') finishTimerEdit();
});

function finishTimerEdit() {
  let val = parseInt(timerInput.value, 10);
  if (isNaN(val) || val < 1) val = 60;
  state.defaultTimer = val;
  state.timerSeconds = val;
  updateTimerDisplay();
  timerInput.style.display = 'none';
  timerDisplay.style.display = 'block';
}

/**
 * Data Management
 */
function addItem() {
  const id = Date.now();
  const nextNum = state.items.length + 1;
  state.items.push({ id, name: `Ìï≠Î™© ${nextNum}`, weight: 1 });
  renderTable();
  renderWheel();
  startTimer();
}

function deleteItem(id) {
  state.items = state.items.filter(item => item.id !== id);
  if (state.items.length === 0) {
    state.items.push({ id: Date.now(), name: 'Ìï≠Î™© 1', weight: 1 });
  }
  renderTable();
  renderWheel();
  startTimer();
}

function updateItem(id, field, value) {
  const item = state.items.find(i => i.id === id);
  if (item) {
    if (field === 'weight') {
      let w = parseInt(value, 10);
      if (isNaN(w) || w < 0) w = 0;
      item.weight = w;
    } else {
      item.name = value;
    }
    renderTable();
    renderWheel();
    startTimer();
  }
}

// Arrow helper function
function changeWeight(id, delta) {
  const item = state.items.find(i => i.id === id);
  if (item) {
    let newW = item.weight + delta;
    if (newW < 0) newW = 0;
    item.weight = newW;
    renderTable();
    renderWheel();
    startTimer();
  }
}

function getTotalWeight() {
  return state.items.reduce((sum, item) => sum + item.weight, 0);
}

/**
 * Rendering
 */
function renderTable() {
  tableBody.innerHTML = '';
  const total = getTotalWeight();

  const validItems = state.items.filter(i => i.name.trim() !== '' && i.weight > 0);
  exportStr.value = validItems.map(i => `${i.name}*${i.weight}`).join(',');

  state.items.forEach(item => {
    const row = document.createElement('div');
    row.className = 'table-row';

    const percent = total > 0 ? ((item.weight / total) * 100).toFixed(1) : '0.0';

    row.innerHTML = `
      <div class="cell-action">
        <button class="btn-delete" onclick="deleteItem(${item.id})">‚úï</button>
      </div>
      <div class="cell-name">
        <input type="text" class="input-ghost" 
          value="${item.name}" 
          placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•"
          oninput="updateItem(${item.id}, 'name', this.value)"
        />
      </div>
      <div class="cell-weight">
        <button class="weight-btn" onclick="changeWeight(${item.id}, -1)">‚óÄ</button>
        <input type="number" class="input-ghost input-number" 
          value="${item.weight}" 
          min="0"
          onchange="updateItem(${item.id}, 'weight', this.value)"
        />
        <button class="weight-btn" onclick="changeWeight(${item.id}, 1)">‚ñ∂</button>
      </div>
      <div class="prob-text">${percent}%</div>
    `;
    tableBody.appendChild(row);
  });
}

function renderWheel() {
  const total = getTotalWeight();
  let accumulatedDeg = 0;
  
  wheelCanvas.innerHTML = '';
  wheelLabels.innerHTML = '';
  
  if (total === 0) {
    wheelCanvas.style.background = '#333';
    return;
  }

  let gradientStr = 'conic-gradient(';
  const assignedColors = [];
  
  state.items.forEach((item, index) => {
    let colorIndex = index % colors.length;
    let selectedColor = colors[colorIndex];

    if (index > 0) {
      if (selectedColor === assignedColors[index - 1]) {
        colorIndex = (colorIndex + 1) % colors.length;
        selectedColor = colors[colorIndex];
      }
    }
    
    if (index === state.items.length - 1 && state.items.length > 1) {
      const firstColor = assignedColors[0];
      while (selectedColor === assignedColors[index - 1] || selectedColor === firstColor) {
        colorIndex = (colorIndex + 1) % colors.length;
        selectedColor = colors[colorIndex];
      }
    }

    assignedColors.push(selectedColor);

    const deg = (item.weight / total) * 360;
    const startDeg = accumulatedDeg;
    const endDeg = accumulatedDeg + deg;
    
    gradientStr += `${selectedColor} ${startDeg}deg ${endDeg}deg,`;
    
    // Add Label
    if (deg > 5 && item.name) { 
      const labelDiv = document.createElement('div');
      labelDiv.className = 'slice-label';
      const midDeg = startDeg + (deg / 2);
      
      // FIX: New alignment logic.
      labelDiv.style.transform = `rotate(${midDeg - 90}deg)`;
      
      labelDiv.innerHTML = `<span>${item.name}</span>`;
      wheelLabels.appendChild(labelDiv);
    }
    
    accumulatedDeg += deg;
  });

  gradientStr = gradientStr.slice(0, -1) + ')';
  wheelCanvas.style.background = gradientStr;
}

/**
 * Mascot Logic
 */
function updateMascot() {
  // If spinning (active) -> Image 1, Else (idle) -> Image 2
  if (state.isSpinning) {
    mascotImg.src = MASCOT_ACTIVE;
  } else {
    mascotImg.src = MASCOT_IDLE;
  }
}

/**
 * Spin Logic
 */
function spinLoop() {
  if (state.spinPhase === 'spinning') {
    state.rotation += 25; // Slightly faster manual spin
    wheelRotator.style.transform = `rotate(${state.rotation}deg)`;
    state.animationId = requestAnimationFrame(spinLoop);
  }
}

spinBtn.addEventListener('click', () => {
  if (state.spinPhase === 'idle') {
    const total = getTotalWeight();
    if (total <= 0) {
      showToast("Î£∞Î†õ Ìï≠Î™©ÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî (ÌÅ¨Í∏∞ > 0)");
      return;
    }

    // Start Spinning
    state.spinPhase = 'spinning';
    state.isSpinning = true;
    updateMascot(); // Switch to active image

    spinBtn.textContent = "Î©àÏ∂îÍ∏∞!";
    spinBtn.classList.add('stop-mode');
    currentResult.textContent = '...';
    
    wheelRotator.style.transition = 'none';
    
    spinLoop();
  } else if (state.spinPhase === 'spinning') {
    // STOP BUTTON PRESSED
    state.spinPhase = 'stopping';
    cancelAnimationFrame(state.animationId);
    spinBtn.disabled = true; 

    // Determine Winner
    const total = getTotalWeight();
    let random = Math.random() * total;
    let winner = null;
    let currentWeight = 0;
    let winnerIndex = 0;

    for (let i = 0; i < state.items.length; i++) {
      currentWeight += state.items[i].weight;
      if (random <= currentWeight) {
        winner = state.items[i];
        winnerIndex = i;
        break;
      }
    }

    // Calculate Target Angle
    let prevWeight = 0;
    for(let j=0; j<winnerIndex; j++) prevWeight += state.items[j].weight;
    
    const startAngle = (prevWeight / total) * 360;
    const sliceAngle = (winner.weight / total) * 360;
    const winnerCenterAngle = startAngle + (sliceAngle / 2);
    
    const currentRotMod = state.rotation % 360; 
    let targetRotMod = (360 - winnerCenterAngle); 
    
    let diff = targetRotMod - currentRotMod;
    if (diff < 0) diff += 360;
    
    // Extra spins for slow deceleration
    const extraSpins = 360 * 6; // More spins for longer time
    const finalRotation = state.rotation + diff + extraSpins;
    
    const fuzz = (Math.random() - 0.5) * (sliceAngle * 0.8);
    
    state.rotation = finalRotation + fuzz;

    // Apply CSS Transition for smooth stop
    // Increased duration to 8s and adjusted bezier for very slow finish
    wheelRotator.style.transition = 'transform 8s cubic-bezier(0.1, 1, 0.1, 1)';
    wheelRotator.style.transform = `rotate(${state.rotation}deg)`;

    // Finish
    setTimeout(() => {
      state.isSpinning = false;
      state.spinPhase = 'idle';
      updateMascot(); // Switch back to idle image

      spinBtn.disabled = false;
      spinBtn.textContent = "ÎèåÎ¶¨Í∏∞!";
      spinBtn.classList.remove('stop-mode');
      
      currentResult.textContent = winner.name;
      winnerText.textContent = winner.name;
      
      modalOverlay.style.display = 'flex';
      void winnerModal.offsetWidth;
      winnerModal.classList.add('show');
    }, 8100); // 8s + 100ms
  }
});

// Modal Close
modalOverlay.addEventListener('click', () => {
  winnerModal.classList.remove('show');
  setTimeout(() => {
    modalOverlay.style.display = 'none';
  }, 300);
});

btnCopy.addEventListener('click', () => {
  exportStr.select();
  document.execCommand('copy');
  showToast('ÌÖçÏä§Ìä∏Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
});

function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), 2000);
}

// Global exposure
window.deleteItem = deleteItem;
window.updateItem = updateItem;
window.changeWeight = changeWeight;

// Init
btnAddItem.addEventListener('click', addItem);
renderTable();
renderWheel();
startTimer();
updateMascot(); // Initial load

</script>
</body>
</html>